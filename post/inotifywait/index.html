<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>inotifywait | Dev-Coco</title>

<link rel="shortcut icon" href="https://dev-coco.github.io/favicon.ico?v=1649561576908">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://dev-coco.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            Dev-Coco
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    首页
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/Featured-Software.html" class="menu gt-a-link">
                    软件
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/Online-Tools" class="menu gt-a-link">
                    在线工具
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/Linux-Command" class="menu gt-a-link">
                    Linux命令
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/Excel" class="menu gt-a-link">
                    Excel教程
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/Terms-and-Privacy" class="menu gt-a-link">
                    隐私与条款
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1649561576908"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* 移动端导航栏展开/收起切换 */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    inotifywait
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2022-02-03 ·
                    </time>
                    
                        <a href="https://dev-coco.github.io/tag/linux-command/" class="post-tags">
                            # Linux命令
                        </a>
                    
                </div>
                <div class="post-content">
                    <p>异步文件系统监控机制。</p>
<!-- more -->
<h2 id="补充说明">补充说明</h2>
<p>Inotify 一种强大的、细粒度的、异步文件系统监控机制，它满足各种各样的文件监控需要，可以监控文件系统的访问属性、读写属性、权限属性、删除创建、移动等操作，也就是可以监控文件发生的一切变化。。</p>
<p>inotify-tools 是一个 C 库和一组命令行的工作提供 Linux 下 inotify 的简单接口。inotify-tools 安装后会得到<code>inotifywait</code>和<code>inotifywatch</code>这两条命令：</p>
<ul>
<li>
<p>inotifywait 命令可以用来收集有关文件访问信息，Linux 发行版一般没有包括这个命令，需要安装 inotify-tools，这个命令还需要将 inotify 支持编译入 Linux 内核，好在大多数 Linux 发行版都在内核中启用了 inotify。</p>
</li>
<li>
<p>inotifywatch 命令 用于收集关于被监视的文件系统的统计数据，包括每个 inotify 事件发生多少次。</p>
</li>
</ul>
<p>开始之前需要检测系统内核是否支持 inotify：</p>
<p>使用<code>uname -r</code>命令检查 Linux 内核，如果低于 2.6.13，就需要重新编译内核加入 inotify 的支持。</p>
<p>使用<code>ll /proc/sys/fs/inotify</code>命令，是否有以下三条信息输出，如果没有表示不支持。</p>
<pre><code class="language-Shell">ll /proc/sys/fs/inotify
total 0
-rw-r--r-- 1 root root 0 Jan  4 15:41 max_queued_events
-rw-r--r-- 1 root root 0 Jan  4 15:41 max_user_instances
-rw-r--r-- 1 root root 0 Jan  4 15:41 max_user_watches
</code></pre>
<h3 id="安装-inotify-tools">安装 inotify-tools</h3>
<ul>
<li>
<p>inotify-tools 项目地址：<a href="https://github.com/rvoicilas/inotify-tools" target="_blank">https://github.com/rvoicilas/inotify-tools</a></p>
</li>
<li>
<p>inotify-tools 下载地址：<a href="http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz" target="_blank">http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</a></p>
</li>
</ul>
<pre><code class="language-Shell">#CentOS release 5.8/64 位：
tar zxvf inotify-tools-3.14.tar.gz
cd inotify-tools-3.14
./configure
make
make install
</code></pre>
<p>其他 Linux 发行版安装方法可以参见：<a href="https://github.com/rvoicilas/inotify-tools/wiki#wiki-getting" target="_blank">https://github.com/rvoicilas/inotify-tools/wiki#wiki-getting</a></p>
<h3 id="inotify-相关参数">inotify 相关参数</h3>
<p>inotify 定义了下列的接口参数，可以用来限制 inotify 消耗 kernel memory 的大小。由于这些参数都是内存参数，因此，可以根据应用需求，实时的调节其大小：</p>
<ul>
<li>
<p><code>/proc/sys/fs/inotify/max_queued_evnets</code>表示调用 inotify_init 时分配给 inotify instance 中可排队的 event 的数目的最大值，超出这个值的事件被丢弃，但会触发 IN_Q_OVERFLOW 事件。</p>
</li>
<li>
<p><code>/proc/sys/fs/inotify/max_user_instances</code>表示每一个 real user id 可创建的 inotify instatnces 的数量上限。</p>
</li>
<li>
<p><code>/proc/sys/fs/inotify/max_user_watches</code>表示每个 inotify instatnces 可监控的最大目录数量。如果监控的文件数目巨大，需要根据情况，适当增加此值的大小。</p>
</li>
</ul>
<p>根据以上在 32 位或者 64 位系统都可以执行：</p>
<pre><code class="language-Shell">echo 104857600 &gt; /proc/sys/fs/inotify/max_user_watches
echo 'echo 104857600 &gt; /proc/sys/fs/inotify/max_user_watches' &gt;&gt; /etc/rc.local
</code></pre>
<p>如果遇到以下错误：</p>
<pre><code class="language-Shell">inotifywait: error while loading shared libraries: libinotifytools.so.0: cannot open shared object file: No such file or directory 
</code></pre>
<pre><code class="language-Shell"> **解决方法：**
32 位系统：ln -s /usr/local/lib/libinotifytools.so.0 /usr/lib/libinotifytools.so.0
64 位系统：ln -s /usr/local/lib/libinotifytools.so.0 /usr/lib64/libinotifytools.so.0
</code></pre>
<h3 id="inotifywait-命令使用">inotifywait 命令使用</h3>
<pre><code class="language-Shell">#!/bin/bash
#filename watchdir.sh
path=$1
/usr/local/bin/inotifywait -mrq --timefmt '%d/%m/%y/%H:%M' --format '%T %w %f' -e modify,delete,create,attrib $path

执行输出：
./watchdir.sh /data/wsdata/tools/
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swx
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swx
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp
04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp
04/01/13/16:35 /data/wsdata/tools/ 4913
04/01/13/16:35 /data/wsdata/tools/ 4913
04/01/13/16:35 /data/wsdata/tools/ 4913
04/01/13/16:35 /data/wsdata/tools/ j.jsp
04/01/13/16:35 /data/wsdata/tools/ j.jsp
04/01/13/16:35 /data/wsdata/tools/ j.jsp
04/01/13/16:35 /data/wsdata/tools/ j.jsp~
04/01/13/16:35 /data/wsdata/tools/ .j.jsp.swp
</code></pre>
<h3 id="inotifywait-命令参数">inotifywait 命令参数</h3>
<ul>
<li>
<p><code>-m</code>是要持续监视变化。</p>
</li>
<li>
<p><code>-r</code>使用递归形式监视目录。</p>
</li>
<li>
<p><code>-q</code>减少冗余信息，只打印出需要的信息。</p>
</li>
<li>
<p><code>-e</code>指定要监视的事件列表。</p>
</li>
<li>
<p><code>--timefmt</code>是指定时间的输出格式。</p>
</li>
<li>
<p><code>--format</code>指定文件变化的详细信息。</p>
</li>
</ul>
<h3 id="可监听的事件">可监听的事件</h3>
<table>
<thead>
<tr>
<th style="text-align:center">事件</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">access</td>
<td style="text-align:center">访问 ，读取文件。</td>
</tr>
<tr>
<td style="text-align:center">modify</td>
<td style="text-align:center">修改 ，文件内容被修改。</td>
</tr>
<tr>
<td style="text-align:center">attrib</td>
<td style="text-align:center">属性 ，文件元数据被修改。</td>
</tr>
<tr>
<td style="text-align:center">move</td>
<td style="text-align:center">移动 ，对文件进行移动操作。</td>
</tr>
<tr>
<td style="text-align:center">create</td>
<td style="text-align:center">创建 ，生成新文件</td>
</tr>
<tr>
<td style="text-align:center">open</td>
<td style="text-align:center">打开 ，对文件进行打开操作。</td>
</tr>
<tr>
<td style="text-align:center">close</td>
<td style="text-align:center">关闭 ，对文件进行关闭操作。</td>
</tr>
<tr>
<td style="text-align:center">delete</td>
<td style="text-align:center">删除 ，文件被删除。</td>
</tr>
</tbody>
</table>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://dev-coco.github.io/post/tcpreplay/" class="post-title gt-a-link">
                    tcpreplay
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">ttest</div>
    <div class="social-container">
        
            
                <a href="https://github.com/dev-coco" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        <span>Copyright © 2020-2022 Dev-Coco - All Rights Reserved.</span>
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://dev-coco.github.io/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
